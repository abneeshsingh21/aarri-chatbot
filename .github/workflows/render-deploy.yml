name: Deploy backend to Render

on:
  workflow_run:
    workflows: ["Build and push Backend Docker image to GHCR"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render deploy using GHCR image
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          IMAGE: ghcr.io/${{ github.repository_owner }}/aarri-chatbot-backend:${{ github.event.workflow_run.head_sha }}
        run: |
          echo "Triggering Render deploy for image: $IMAGE"
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "ERROR: RENDER_API_KEY and RENDER_SERVICE_ID must be set in repository secrets.";
            exit 1;
          fi
          API_URL="https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys"
          body=$(jq -n --arg img "$IMAGE" '{dockerImage: $img}')
          echo "POST $API_URL -> $body"
          resp=$(curl -s -X POST "$API_URL" -H "Authorization: Bearer $RENDER_API_KEY" -H "Content-Type: application/json" -d "$body")
          echo "Render response: $resp"
          # Optional: check for errors
          if echo "$resp" | jq -e '.error' > /dev/null 2>&1; then
            echo "Render API returned an error:"; echo "$resp"; exit 1;
          fi
